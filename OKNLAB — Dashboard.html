<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OKNLAB ‚Äî Agent Command Center</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Inter', sans-serif; background-color: #0a0a0a; color: #e5e5e5; }
  .mono { font-family: 'JetBrains Mono', monospace; }
  .glass { background: rgba(20, 20, 20, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); }
  .glow-text { text-shadow: 0 0 10px rgba(255,255,255,0.2); }
  .sidebar-item { transition: all 0.2s; cursor: pointer; border-left: 2px solid transparent; }
  .sidebar-item:hover, .sidebar-item.active { background: rgba(255,255,255,0.05); border-left-color: #3b82f6; }
  .msg-user { background: #1e1e1e; border: 1px solid #333; align-self: flex-end; }
  .msg-ai { background: #111; border: 1px solid #333; align-self: flex-start; border-left: 2px solid #10b981; }
  .terminal { background: #000; color: #0f0; font-size: 12px; border-top: 1px solid #333; }
</style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

  <!-- Header -->
  <header class="h-14 border-b border-white/10 flex items-center px-6 justify-between glass z-10">
    <div class="flex items-center gap-3">
      <div class="w-4 h-4 bg-blue-600 rounded-sm"></div>
      <h1 class="font-bold tracking-wider text-lg glow-text">OKNLAB <span class="text-xs text-gray-500 font-normal">V2.0 ENTERPRISE</span></h1>
    </div>
    <div class="flex items-center gap-4 text-xs mono text-gray-400">
      <span class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> SYSTEM ONLINE</span>
      <span>GPU: ACTIVE</span>
      <span id="clock">00:00:00</span>
    </div>
  </header>

  <div class="flex flex-1 min-h-0">
    <!-- Sidebar -->
    <aside class="w-64 border-r border-white/10 flex flex-col py-4 bg-[#0f0f0f]">
      <div class="px-6 mb-4 text-xs font-bold text-gray-500 uppercase tracking-widest">Core Agents</div>
      <nav class="flex-1 flex flex-col gap-1">
        <div class="sidebar-item active px-6 py-3 flex items-center gap-3" onclick="setAgent('CodeArchitect')">
          <span class="text-blue-400">‚ö°</span>
          <div>
            <div class="font-medium text-sm">CodeArchitect</div>
            <div class="text-[10px] text-gray-500">Python, JS, Rust Dev</div>
          </div>
        </div>
        <div class="sidebar-item px-6 py-3 flex items-center gap-3" onclick="setAgent('SecAnalyst')">
          <span class="text-red-400">üõ°Ô∏è</span>
          <div>
            <div class="font-medium text-sm">SecAnalyst</div>
            <div class="text-[10px] text-gray-500">Audit & Threat Models</div>
          </div>
        </div>
        <div class="sidebar-item px-6 py-3 flex items-center gap-3" onclick="setAgent('AutoBot')">
          <span class="text-yellow-400">ü§ñ</span>
          <div>
            <div class="font-medium text-sm">AutoBot</div>
            <div class="text-[10px] text-gray-500">Workflow Automation</div>
          </div>
        </div>
        <div class="sidebar-item px-6 py-3 flex items-center gap-3" onclick="setAgent('CreativeAgent')">
          <span class="text-purple-400">‚ú®</span>
          <div>
            <div class="font-medium text-sm">CreativeAgent</div>
            <div class="text-[10px] text-gray-500">Generative Content</div>
          </div>
        </div>
      </nav>
      
      <div class="px-6 mt-auto">
        <div class="p-3 bg-white/5 rounded border border-white/5">
          <div class="text-[10px] text-gray-400 mb-1">ACTIVE MODEL</div>
          <div class="text-xs font-bold text-white">Qwen2.5-1.5B-Instruct</div>
          <div class="text-[10px] text-blue-400 mt-1">4-bit Quantization</div>
        </div>
      </div>
    </aside>

    <!-- Main Workspace -->
    <main class="flex-1 flex flex-col relative">
      <!-- Chat Area -->
      <div id="chat-container" class="flex-1 overflow-y-auto p-6 flex flex-col gap-4 scroll-smooth">
        <div class="text-center text-gray-600 text-sm my-10">
          Welcome to OKNLAB. Select an agent and begin operation.
        </div>
      </div>

      <!-- Input Area -->
      <div class="p-4 border-t border-white/10 bg-[#0a0a0a]">
        <div class="relative max-w-4xl mx-auto">
          <textarea id="prompt" rows="2" 
            class="w-full bg-[#1a1a1a] border border-white/10 rounded-lg p-4 pr-24 text-sm focus:outline-none focus:border-blue-500 resize-none mono text-gray-300"
            placeholder="Command the agent (e.g., 'Audit this code' or 'Search for latest RAG techniques')..."></textarea>
          <div class="absolute right-3 bottom-3 flex gap-2">
             <button id="sendBtn" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-1.5 rounded text-xs font-bold transition">RUN</button>
          </div>
        </div>
      </div>

      <!-- Terminal / Log Panel -->
      <div class="h-32 terminal p-3 mono overflow-y-auto" id="terminal">
        <div class="text-gray-500">OKNLAB System Log Initialized...</div>
        <div class="text-gray-500">Waiting for MCP connection...</div>
      </div>
    </main>
  </div>

<script>
  let currentAgent = 'CodeArchitect';
  const chatContainer = document.getElementById('chat-container');
  const terminal = document.getElementById('terminal');
  const promptInput = document.getElementById('prompt');

  function log(msg, type='info') {
    const div = document.createElement('div');
    div.innerHTML = `<span class="text-gray-500">[${new Date().toLocaleTimeString()}]</span> ${msg}`;
    if(type==='error') div.style.color = '#ef4444';
    if(type==='success') div.style.color = '#10b981';
    terminal.appendChild(div);
    terminal.scrollTop = terminal.scrollHeight;
  }

  function setAgent(agent) {
    currentAgent = agent;
    document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
    event.currentTarget.classList.add('active');
    log(`Switched Active Agent to: ${agent}`, 'success');
  }

  function appendMessage(role, text) {
    const div = document.createElement('div');
    div.className = `p-4 rounded-lg max-w-[80%] text-sm leading-relaxed whitespace-pre-wrap ${role === 'user' ? 'msg-user' : 'msg-ai'}`;
    div.innerHTML = text; // Warning: sanitize in prod
    chatContainer.appendChild(div);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  async function sendMessage() {
    const text = promptInput.value.trim();
    if(!text) return;
    
    promptInput.value = '';
    appendMessage('user', text);
    log(`Processing request via ${currentAgent}...`);

    try {
      // In local ngrok setup, standard fetch works against the relative root if served by FastAPI
      // If standalone, you might need the full URL. Assuming served by FastAPI at /dashboard
      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: text, agent_mode: currentAgent })
      });
      
      if(!res.ok) throw new Error(`API Error ${res.status}`);
      
      const data = await res.json();
      if(data.status === 'error') {
        appendMessage('ai', `**System Error:** ${data.response}`);
        log(data.response, 'error');
      } else {
        appendMessage('ai', data.response);
        log('Response received.', 'success');
      }
    } catch (e) {
      appendMessage('ai', `**Connection Failed:** ${e.message}`);
      log(e.message, 'error');
    }
  }

  document.getElementById('sendBtn').addEventListener('click', sendMessage);
  promptInput.addEventListener('keydown', (e) => {
    if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  });

  // Clock
  setInterval(() => {
    document.getElementById('clock').innerText = new Date().toLocaleTimeString();
  }, 1000);

  log('System Ready. Ngrok Tunnel Active.');
</script>
</body>
</html>
